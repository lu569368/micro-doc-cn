# 容错

**目录**

## 容错

分布式系统世界中，故障一直在发生。Micro上尝试使用一些容错的最佳实践来解决这个问题。本文描述了配置它们的一些方法。

### 心跳(Heartbeating)

心跳是服务发现中刷新注册的一种机制。

#### 原理阐述

服务在启动时向服务发现注册，在关闭时注销。有时这些服务可能会意外死亡、被强制终止或面临临时网络问题。在这些情况下，旧的节点将留在服务发现中。如果服务被自动删除，这将是理想的。

#### 解决方案

基于这个原因，Micro支持注册TTL和注册间隔的选项。TTL指定注册在发现服务中应该存在多长时间，在此之后注册过期并被删除。间隔时间是服务应该再次注册时间，以保持其在服务发现中的注册状态。

这些选项在go-micro中是可用，在micro工具箱中作为参数(flag)使用。

#### 用例

对于微工具包，只需使用内建的参数来设置ttl和interval。

~~~ shell
micro --register_ttl=30 --register_interval=15 api
~~~

这个示例显示我们将ttl设置为30秒，重新注册间隔为15秒。

对于go-micro，在声明微服务时，可以将设置以time.Duration类型传递到选项中

~~~go

service := micro.NewService(
        micro.Name("com.example.srv.foo"),
        micro.RegisterTTL(time.Second*30),
        micro.RegisterInterval(time.Second*15),
)

~~~

### 负载均衡

负载均衡是一种分散请求负载或保持高可用性的方法。

#### 原理阐述

任何单进程应用的可用性和可伸缩性都有局限性。如果应用程序因任何原因死亡，您将无法再为请求提供服务。如果向应用程序发送了足够的请求负载，它可能会开始缓慢响应，或者根本不响应。跨应用程序的多个副本发送请求可以解决这些问题。

#### 解决方案

Micro通过[selector](https://godoc.org/github.com/micro/go-micro/selector#Selector)接口实现客户端负载平衡，将请求分散到服务的任意数量的节点上。当服务启动时，它将作为服务节点注册到服务发现，服务节点唯一地址和id的服务节点。selector使用服务注册中心查找服务的节点，然后使用负载平衡策略(如随机散列或循环)选择要发送请求的节点。

#### 用例

go-micro客户端内置了客户端负载平衡功能。这是自动完成的。

### 重试

重试是在请求失败时重试该请求的一种方法。

#### 原理阐述

由于各种原因，请求可能失败；网络错误，请求负载，应用程序死亡。在这些情况下，如果我们能够针对应用程序的不同副本重试请求，以获得成功的响应，这将是理想的。

#### 解决方案

微客户端包括一种重试请求的机制。selector(上面提到的)返回下一个函数，该函数在执行时使用负载平衡策略从列表中返回节点。下一个函数可以多次执行，根据负载平衡策略返回一个新节点。设置重试后，如果请求失败，将执行下一个函数，并在新节点上重试该请求。

#### 用例

可以将重试设置为客户端的参数(flag)或选项(option)。它默认值为1，这意味着对一个请求进行1次尝试。

通过参数(flag)更改

~~~  shell
micro --client_retries=3
~~~

通过选项设置

~~~ go
client.Init(
    client.Retries(3),
)
~~~

### 缓存的发现

发现缓存是客户端对服务发现信息的缓存

#### 原理阐述

服务发现是微服务的核心依赖项，但如果架构不正确，也可能成为单点故障。每个发现系统都有自己的可伸缩性和高可用性属性。如果发现服务出现故障，则会使系统的其他部分无法使用，因为服务不知道如何将名称解析为地址。如果对系统中的每个请求都进行了查找，那么发现也可能成为瓶颈。

#### 解决方案

客户端缓存是一种消除服务发现瓶颈和单点故障的方法。Micro包括一个selector(客户端负载均衡器)，它在内存中维护与之相关的服务发的缓存。如果发生缓存丢失，选择器将在服务注册中心进行查找并缓存数据。缓存还会定期地进行调整，以确保不存在过时的数据。

#### 用例

缓存选择器可以通过命令行参数(flag)设置，也可以在创建新服务时设置。

作为micro工具箱的参数，执行以下操作

~~~shell

micro --selector=cache api
~~~

如果调用Init方法，Go-micro服务也可以使用相同的命令行参数。或者可以在代码中设置选择器。

~~~go

import (
    "github.com/micro/go-micro/client"
    "github.com/micro/go-micro/selector/cache"
)

service := micro.NewService(
    micro.Name("com.example.srv.foo"),
)

service.Client().Init(cache.NewSelector())

~~~
